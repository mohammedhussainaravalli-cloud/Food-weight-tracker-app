<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weight & Meal Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      display: flex;
      min-height: 100vh;
    }
    header {
      background: #007bff;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.2rem;
      flex-shrink: 0;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 10;
    }
    .container {
      margin-top: 70px;
      padding: 1rem;
      flex: 1;
      display: flex;
    }
    .sidebar {
      width: 220px;
      background: #343a40;
      color: #fff;
      padding: 1rem;
      flex-shrink: 0;
      height: calc(100vh - 70px);
      position: sticky;
      top: 70px;
    }
    .sidebar h3 {
      margin-top: 0;
    }
    .sidebar button {
      display: block;
      margin: 0.5rem 0;
      padding: 0.5rem;
      width: 100%;
      border: none;
      background: #495057;
      color: #fff;
      cursor: pointer;
    }
    .sidebar button:hover {
      background: #6c757d;
    }
    .main {
      flex: 1;
      padding: 1rem;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    .form-group {
      margin-bottom: 0.75rem;
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button.primary {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 4px;
      cursor: pointer;
    }
    button.primary:hover {
      background: #0056b3;
    }
    #feelingRating span {
      font-size: 1.5rem;
      cursor: pointer;
    }
    #feelingRating span.selected {
      color: orange;
    }
    .loading {
      display: none;
      font-size: 0.8rem;
      color: #666;
    }
    .message {
      margin-top: 0.5rem;
      display: none;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
    }
    .message.success {
      background: #d4edda;
      color: #155724;
    }
  </style>
</head>
<body>
  <header>Weight & Meal Tracker</header>
  <div class="container">
    <div class="sidebar">
      <h3>Menu</h3>
      <button onclick="showSection('dashboard')">Dashboard</button>
      <button onclick="showSection('meal')">Log Meal</button>
      <button onclick="showSection('weight')">Log Weight</button>
    </div>
    <div class="main">
      <!-- Dashboard -->
      <div id="dashboard" class="card section">
        <h2>Today's Calories</h2>
        <p><span id="dailyCalories">0</span> kcal</p>
        <h2>Current Weight</h2>
        <p><span id="currentWeightValue">--</span></p>
        <h2>Motivation</h2>
        <p id="quoteOfTheDay">Loading...</p>
        <h2>Weight History</h2>
        <canvas id="weightChart" height="100"></canvas>
      </div>

      <!-- Log Meal -->
      <div id="meal" class="card section" style="display:none;">
        <h2>Log a Meal</h2>
        <div class="form-group">
          <label>Hour</label>
          <input type="number" id="mealHour" placeholder="e.g., 14" />
        </div>
        <div class="form-group">
          <label>Meal Type</label>
          <select id="mealType">
            <option value="">--Select--</option>
            <option>Breakfast</option>
            <option>Lunch</option>
            <option>Dinner</option>
            <option>Snack</option>
          </select>
        </div>
        <div class="form-group">
          <label>Meal Description</label>
          <textarea id="mealDescription"></textarea>
        </div>
        <div class="form-group">
          <label>Approx Calories</label>
          <input type="number" id="calories" />
        </div>
        <div class="form-group">
          <label>How did you feel?</label>
          <div id="feelingRating">
            <span onclick="setFeeling(1)">üòû</span>
            <span onclick="setFeeling(2)">üòê</span>
            <span onclick="setFeeling(3)">üòä</span>
            <span onclick="setFeeling(4)">üòÉ</span>
            <span onclick="setFeeling(5)">ü§©</span>
          </div>
        </div>
        <button id="logMealBtn" class="primary" onclick="logMeal()">
          <span class="btn-text">Save Meal</span>
          <span class="loading">Saving...</span>
        </button>
        <div id="mealMessage" class="message"></div>
      </div>

      <!-- Log Weight -->
      <div id="weight" class="card section" style="display:none;">
        <h2>Log Weight</h2>
        <div class="form-group">
          <label>Weight (kg)</label>
          <input type="number" id="weightInput" step="0.1" />
        </div>
        <button id="logWeightBtn" class="primary" onclick="logWeight()">
          <span class="btn-text">Save Weight</span>
          <span class="loading">Saving...</span>
        </button>
        <div id="weightMessage" class="message"></div>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzBgcGr-rtg3dQ_gN8nRuXp2nPamo5XGTWIHU_WNja4O4cnMSL6tZX95_htK0nmR8Z7/exec"; // <-- replace

    let selectedFeeling = 0;
    let weightChart;

    // ========= UI NAV =========
    function showSection(id) {
      document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }
    function setFeeling(val) {
      selectedFeeling = val;
      document.querySelectorAll('#feelingRating span').forEach((s, i) => {
        s.classList.toggle('selected', i + 1 === val);
      });
    }

    // ========= JSONP =========
    function jsonpRequest(action, params = {}, timeoutMs = 8000) {
      return new Promise((resolve, reject) => {
        const cbName = "__cb_" + Math.random().toString(36).substr(2,9);
        window[cbName] = (data) => { cleanup(); resolve(data); };
        const qs = new URLSearchParams({ action, callback: cbName, ...params }).toString();
        const script = document.createElement("script");
        script.src = APPS_SCRIPT_URL + "?" + qs;
        script.onerror = () => { cleanup(); reject(new Error("JSONP error")); };
        const timer = setTimeout(() => { cleanup(); reject(new Error("JSONP timeout")); }, timeoutMs);
        function cleanup() {
          if (script.parentNode) script.parentNode.removeChild(script);
          delete window[cbName];
          clearTimeout(timer);
        }
        document.head.appendChild(script);
      });
    }
    async function apiCall(action, data={}) {
      return jsonpRequest(action, data);
    }

    // ========= HELPERS =========
    function showMsg(id, text, type="success") {
      const el = document.getElementById(id);
      el.textContent = text;
      el.className = "message " + type;
      el.style.display = "block";
      setTimeout(() => el.style.display="none", 4000);
    }
    function toggleLoading(btnId, show) {
      const btn = document.getElementById(btnId);
      if (!btn) return;
      btn.disabled = show;
      btn.querySelector(".loading").style.display = show ? "inline" : "none";
    }

    // ========= FUNCTIONS =========
    async function logMeal() {
      const hour = document.getElementById("mealHour").value;
      const mealType = document.getElementById("mealType").value;
      const desc = document.getElementById("mealDescription").value.trim();
      const cal = document.getElementById("calories").value;
      if (!hour || !mealType || !desc || !selectedFeeling) {
        showMsg("mealMessage","Fill all required fields.","error");
        return;
      }
      toggleLoading("logMealBtn",true);
      try {
        const today = new Date().toLocaleDateString("en-GB");
        const res = await apiCall("logMeal",{ date:today,hour,mealType,mealDescription:desc,calories:cal,feeling:selectedFeeling });
        if (res.error) throw new Error(res.error);
        showMsg("mealMessage","Meal saved!","success");
        updateDailyCalories(); loadCurrentWeight();
      } catch(e) {
        showMsg("mealMessage","Failed: "+e.message,"error");
      }
      toggleLoading("logMealBtn",false);
    }

    async function logWeight() {
      const weight = document.getElementById("weightInput").value;
      if (!weight) { showMsg("weightMessage","Enter weight.","error"); return; }
      toggleLoading("logWeightBtn",true);
      try {
        const today = new Date().toLocaleDateString("en-GB");
        const res = await apiCall("logWeight",{ date:today,weight });
        if (res.error) throw new Error(res.error);
        showMsg("weightMessage","Weight logged!","success");
        loadCurrentWeight(); loadWeightHistory();
      } catch(e) {
        showMsg("weightMessage","Failed: "+e.message,"error");
      }
      toggleLoading("logWeightBtn",false);
    }

    async function updateDailyCalories() {
      const today = new Date().toLocaleDateString("en-GB");
      try {
        const res = await apiCall("getDailyCalories",{ date:today });
        document.getElementById("dailyCalories").textContent = res.calories || 0;
      } catch { document.getElementById("dailyCalories").textContent="0"; }
    }
    async function loadCurrentWeight() {
      try {
        const res = await apiCall("getCurrentWeight");
        document.getElementById("currentWeightValue").textContent = (res.weight||"--")+" kg";
      } catch { document.getElementById("currentWeightValue").textContent="--"; }
    }
    async function loadQuoteOfTheDay() {
      try {
        const res = await apiCall("getQuote");
        document.getElementById("quoteOfTheDay").textContent = res.quote || "Keep going!";
      } catch { document.getElementById("quoteOfTheDay").textContent="Stay strong!"; }
    }
    async function loadWeightHistory() {
      try {
        const res = await apiCall("getWeights");
        const labels = res.weights.map(w=>w.date);
        const data = res.weights.map(w=>w.weight);
        if (weightChart) weightChart.destroy();
        weightChart = new Chart(document.getElementById("weightChart"), {
          type:"line",
          data:{ labels, datasets:[{ label:"Weight (kg)", data, borderColor:"#007bff", fill:false }] }
        });
      } catch(e){ console.error(e); }
    }

    // ========= INIT =========
    document.addEventListener("DOMContentLoaded",()=>{
      loadQuoteOfTheDay(); updateDailyCalories(); loadCurrentWeight(); loadWeightHistory();
    });
  </script>
</body>
</html>
